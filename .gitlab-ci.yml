image: python:3

stages:
- build
- release


build:linux:
  stage: build
  before_script:
  - pip install poetry
  script:
  - poetry install
  - poetry run pyinstaller devtool/devtool.py --onefile
  artifacts:
    name: linux
    paths:
    - dist/devtool
    expire_in: 30 days

build:mac:
  tags:
  - osx
  stage: build
  before_script:
  - python3 -m venv .venv
  - source .venv/bin/activate
  - pip install poetry
  script:
  - poetry install
  - poetry run pyinstaller devtool/devtool.py --onefile
  artifacts:
    name: osx
    paths:
    - dist/devtool
    expire_in: 30 days

release:mac:
  only:
  - tags
  tags:
  - osx
  stage: release
  before_script:
  - python3 -m venv .venv
  - source .venv/bin/activate
  - pip install gitlab-release
  script
  - cp dist/devtool dist/devtool-$CI_COMMIT_TAG-OSX
  - python -m gitlab_release $PRIVATE_TOKEN dist/devtool-$CI_COMMIT_TAG-OSX
